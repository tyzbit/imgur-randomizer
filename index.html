<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>Random Imgur Generator</title>
	<meta name="Description" content="Generate imgur images randomly">
	<script type='text/javascript' src='http://code.jquery.com/jquery-1.5.2.js'></script>
	<script type='text/javascript' src='analytics.js'></script>
<!--	<script type='text/javascript' src='masonry.pkgd.min.js'></script> -->
	<script type='text/javascript' src='riveted.min.js'></script>
	<script>riveted.init({idleTimeout: 120, reportInterval: 10});</script>
	<link rel="stylesheet" type="text/css" href="style.css" />
<center>
<div id=topbar>
<div id=topbar_right></div>
</div>
<script type='text/javascript'>
// run when the window loads
$(window).load(function(){

var size = "250px";
var flag = false;
var firstrun = 1;
//
// functions
//

// called when the user wants to start browsing
	function browse(e) {
		// start browsing
		if ( e == 1 ) {
			// send analytics that the user started browsing
			ga('send', 'event', 'click', 'Started browsing');
			// allow mouseover effects on the disable button
			flag = true;
			// fade out instructions
			$("#instructions").css( "opacity", "0");
			// fade in disable button
			$("#quit").css( "opacity", ".8");
			// make sure images are opaque
			$("img").css( "opacity", "1");
			// make it so mouseover on the top box fades it in and out
			$("#quit").mouseenter(function() {
				// "flag" is set when the user disables loading new images
				if (flag) {
				$(this).css( "opacity", "1");
				};
			});
			$("#quit").mouseleave(function() {
				if(flag) {
					$(this).css( "opacity", ".8");
				}
				});
			$("#quit").click(function() {
				browse(0);
			});
			// set default image width (medium) only if this is the first run
			if ( firstrun == 1) {
				changesize("medium");
			}
			// call the routine that will determine if it needs to pull more images to fill the <div>
			browseVar = window.setInterval(function(){checkroutine()},50);
		};
		// stop browsing
		if ( e == 0 ) {
			// send analytics that the user stopped browsing
			ga('send', 'event', 'click', 'Stopped browsing');
			// darken the page
			$("img").css( "opacity", ".5");
			// this is what stops loading new images
			window.clearInterval(browseVar);
			// bring back the instructions, but with different text
			$("#instructions").html( "Click here to resume");
			$("#instructions").css( "opacity", "1");
			// fade out the quit option
			$("#quit").css( "opacity", "0");
			// disable the quit effects
			flag = false;
			// set this global var so when the user re-enables the size preference is not changed
			firstrun = 0;
		};
	};
// hunt for images, then add them to the <div>
	var Imgur = {
		// main routine, use when you want to add another random image
		fetch: function(num,size) {
			var self=this;
			// for loop through the requested number of images
			for (var x = 0; x < num; x++) {
				// start the hunt, get back "id" which will be a valid imgur ID
				self.hunt(function(id) {
					// push the image and link to the <div>
					// imgur accepts any id with .jpg, even if it's a gif or png
					// <id>s.png is a smaller, thumbnail-sized image
					$('#images').append("<a href='http://i.imgur.com/" + id + ".jpg' class='item' id='i' target='_blank' rel='noreferrer' ><img src='http://i.imgur.com/" + id + "s.png' width='" + size + "' onclick=\"ga('send', 'event', 'click', 'Clicked image')\"/></a>");
				});
			}
		},
		// find a valid imgur id
		hunt: function(cb) {
			var self=this,
				//get a random string, set it to the ID
				id = self.random(5),
				// try loading the image
				img = new Image;
					img.src = "http://i.imgur.com/"+id+"s.png";
					img.onload = function() {
						// check the dimensions of the image
						if ((img.width==198 && img.height==160) || (img.width==161 && img.height==81)) {
							// assume this is an imgur error image according to dimensions, and retry.
							fail();
						} else {
							// return valid ID
							cb(id);
						}
					}
					img.onerror = fail; // no escape.
			// if it fails to find an ID, try again
			function fail() {
				self.hunt(cb);
			}
		},
		// generate a random imgur ID using a set of alphanumeric characters
		random: function(len) {
			var imgurcache = new Array();
			var text = new Array();
			// possible characters
			var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
			// for until len is 0
			for (var i=0; i < len; i++) {
				imgurchar = possible.charAt(Math.floor(Math.random() * possible.length));
				if (text.indexOf(imgurchar) == -1) {
					text.push(imgurchar);
				} else {
					i--;
				}
			}
			text = text.join('');
			if (imgurcache.indexOf(text) == -1) {
				imgurcache.push(text);
				return text;
			} else {
				self.random(5);
				return false;
			}
		}
	};

//below taken from http://www.howtocreate.co.uk/tutorials/javascript/browserwindow
function getScrollXY() {
    var scrOfX = 0, scrOfY = 0;
    if( typeof( window.pageYOffset ) == 'number' ) {
        //Netscape compliant
        scrOfY = window.pageYOffset;
        scrOfX = window.pageXOffset;
    } else if( document.body && ( document.body.scrollLeft || document.body.scrollTop ) ) {
        //DOM compliant
        scrOfY = document.body.scrollTop;
        scrOfX = document.body.scrollLeft;
    } else if( document.documentElement && ( document.documentElement.scrollLeft || document.documentElement.scrollTop ) ) {
        //IE6 standards compliant mode
        scrOfY = document.documentElement.scrollTop;
        scrOfX = document.documentElement.scrollLeft;
    }
    return [ scrOfX, scrOfY ];
}

//taken from http://james.padolsey.com/javascript/get-document-height-cross-browser/
function getDocHeight() {
    var D = document;
    return Math.max(
        D.body.scrollHeight, D.documentElement.scrollHeight,
        D.body.offsetHeight, D.documentElement.offsetHeight,
        D.body.clientHeight, D.documentElement.clientHeight
    );
}

// routine that is called often to check if we need more images loaded
function checkroutine() {
	// check if the document has scrolled within 200 px of the bottom
    if (getDocHeight() < getScrollXY()[1] + window.innerHeight + 200) {
		// get another image
		Imgur.fetch(1,size);
    }
	// make sure the images are the right size
	changesize(size);
};

function changesize(size) {
	if ( size == "small" ) {
		// default imgur thumbnail is 90px anyway
		$("img").css( "width", "90px");
	};
	if ( size == "medium" ) {
		$("img").css( "width", "150px");
	};
	if ( size == "large" ) {
		$("img").css( "width", "250px");
	};
};

//
// event handlers
//

	// check for pressed keys
	$(document).keyup(function(e) {
		// escape
		if (e.keyCode == 27) { browse(0); }
		// R
		if (e.keyCode == 82) { browse(1); }
	});
	// if the user clicks the instructions, start loading new images
	$("#instructions").click(function() {
		browse(1);
	});
	// call a function with the text of the link the user clicked to set the size preference
	$("#size a").click(function() {
		size = $(this).text();
		ga('send', 'event', 'click', 'Changed size to ' + size);
		changesize(size);
	});
});
</script></head>
<body>
<div id="images" class="js-masonry" data-masonry-options='{ "columnWidth": 200, "itemSelector": ".item" }'>
</div>
<div id="quit">
Click here to disable randomizer
</div>
<div id="instructions">
Click here to enable randomizer
</div>
<span id="disclaimer">
By using this service, you agree to <a href="http://imgur.com/removalrequest/">report</a> anything that violates Imgur's <a href="http://imgur.com/tos">TOS</a>
</span>
<span id="size">
image size: <a href="#">small</a> <a href="#">medium</a> <a href="#">large</a>
</span>
</body>
</html>
