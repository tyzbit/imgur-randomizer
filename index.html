<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Endless Imgur</title>
<link rel="stylesheet" href="style.css" />
</head>
<body onload="var interVal = window.setInterval('scroll();', 1000);">
<div id="header">Endless Imgur</div>
<div id="container"></div>
<span id="sidebar"><button onclick="window.clearInterval(interVal)">STOP</button></span>
</body>
</html>
<script>
var contentHeight = 800;
var pageHeight = document.documentElement.clientHeight;
var scrollPosition;
var imageQueue = []; //URLs of the images
var cacheQueue = 0; //counter for the number of images in the cache
var img_loading = false; //used to wait until the image has loaded before checking it
var imgObject = new Image(); //temporary DOM image object

		 imgObject.onerror = function() { img_loading = false; cacheImages(); }; //when the image fails to load, run cacheImages() again
		 
		 imgObject.onload = function() {
				if (this.width == 161 && this.height == 81) { //check if the image is the imgur "not found" image
					imgObject.src = "http://i.imgur.com/" + randomString(5) + ".jpg"; //try a different URL, then break from the function
					return;
				}
				while(cacheQueue<9) { //once there are 9 images cached, do not run this any more
				imageQueue.push([imgObject.src]); //push the URL into the image queue array
				cacheQueue++;
				img_loading = false; 
				cacheImages(); //now that we have put a good URL in the array, we need another.
				}
				putImages(); //if it gets here, there are 9 images in the array and it's ready to display them
				}
				
function randomString(string_length) { //generates a string in the same way imgur does for its naming convention
			var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghiklmnopqrstuvwxyz";
			var output = "";
			var index;

			for (var i = 0; i < string_length; i++) {
					var index = Math.floor(Math.random() * chars.length);
					output += chars.substring(index, index + 1);
			}

			return output;
		}

function cacheImages() { //tests if the image is already loading, if not give it a URL to load
				if (img_loading) return;
				img_loading = true;
				imgObject.src = "http://i.imgur.com/" + randomString(5) + ".jpg";
				}
				


function putImages(){ //display the images with proper formatting
			  var j = 0;
			  for(i=0; i<9; i++){
				  if(imageQueue[0] != ""){
					 document.getElementById("container").innerHTML += '<a href="'+imageQueue[0]+'"><img src="'+imageQueue[0]+'" style="width: 200px; height: 200px;" /></a>';
					 j++;
					 imageQueue.shift();
					 cacheQueue--;
				  
					 if(j == 3 || j == 6)
						  document.getElementById("container").innerHTML += '<br />';
					  else if(j == 9){
						  document.getElementById("container").innerHTML += '<p>'+"<a href='#header'>top</a></p><br /><hr />";
						  j = 0;
					  }
				  }
			  }
		  }		
		
function scroll(){ //called on a regular basis, it checks to see if the page has scrolled far enough to render the next 9 image section
	if(navigator.appName == "Microsoft Internet Explorer")
		scrollPosition = document.documentElement.scrollTop;
	else
		scrollPosition = window.pageYOffset;		
	
	if((contentHeight - pageHeight - scrollPosition) < 800){
		cacheImages(); //looks like we need to render the next section
		contentHeight += 800;		
	}
}

</script>

